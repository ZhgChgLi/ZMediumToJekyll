---
title: Android æŠ“åˆ°äº†ï¼Memory Leak
author: Roy Huang
date: 2022-01-06T05:08:38.636+0000
last_modified_at: 2022-01-19T04:39:21.266+0000
categories: Pinkoi Engineering
tags: [android,memory-leak,pinkoi]
description: åœ¨ Android çš„é–‹ç™¼ä¸­ï¼Œä½ ä¹Ÿè¨±è½é/é‡åˆ°éï¼Œåˆæˆ–æ˜¯ã€Œè¢«å•éã€ memory leakï¼Œæˆ‘å€‘éƒ½çŸ¥é“ memory leak å¾ˆé‡è¦ï¼Œä½†æ˜¯ï¼Œmemory leak åˆ°åº•æ˜¯ä»€éº¼ï¼Ÿ
image:
  path: assets/7d80684dc260/0*9khrSbdf3cf3SWGO
render_with_liquid: false
---

### \[Android\] æŠ“åˆ°äº†ï¼Memory Leak


![Photo by [Daan Mooij](https://unsplash.com/@daanmooij?utm_source=medium&utm_medium=referral){:target="_blank"} on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral){:target="_blank"}](/assets/7d80684dc260/0*9khrSbdf3cf3SWGO)

Photo by [Daan Mooij](https://unsplash.com/@daanmooij?utm_source=medium&utm_medium=referral){:target="_blank"} on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral){:target="_blank"}

åœ¨ Android çš„é–‹ç™¼ä¸­ï¼Œä½ ä¹Ÿè¨±è½é/é‡åˆ°éï¼Œåˆæˆ–æ˜¯ã€Œè¢«å•éã€ memory leakï¼Œæˆ‘å€‘éƒ½çŸ¥é“ memory leak å¾ˆé‡è¦ï¼Œä½†æ˜¯ï¼Œmemory leak åˆ°åº•æ˜¯ä»€éº¼ï¼Ÿ

éš¨è‘— Pinkoi Android Appçš„ä½¿ç”¨äººæ•¸é€æ¼¸æ”€å‡ã€ä½¿ç”¨è€…é€›çš„å•†å“è¶Šä¾†è¶Šå¤šï¼ŒMemory leak çš„å•é¡Œä¹Ÿæ¼¸æ¼¸çš„æµ®ä¸Šæª¯é¢\(æ±—\)ï¼Œæ‰€ä»¥å°±èŠ±äº†ä¸€äº›æ™‚é–“è™•ç†ä¸¦ä¸”è¨˜éŒ„ä¸€ä¸‹ã€‚
### ä»€éº¼æ˜¯ Memory Leakï¼Ÿ

ä¸­æ–‡ç¿»è­¯ç‚ºã€Œè¨˜æ†¶é«”æ´©æ¼ã€ï¼ŒåŸå› å¤§å¤šæ˜¯å‡ºè‡³æ–¼é–‹ç™¼è€…åœ¨é–‹ç™¼æ™‚å› ç–å¤±æˆ–éŒ¯èª¤å°è‡´ã€Œç¨‹å¼å·²ç¶“åŸ·è¡ŒçµæŸäº†ï¼Œå»ä¸èƒ½é‡‹æ”¾è¨˜æ†¶é«”ã€ï¼Œé€²è€Œç”¢ç”Ÿ OOM \(Out Of Memory\)ã€‚

Java çš„ JVM æœ‰æ‰€è¬‚çš„ã€Œåƒåœ¾å›æ”¶æ©Ÿåˆ¶ï¼ˆGarbage collectionï¼‰ã€ï¼Œå®ƒæœƒå»è¿½ä¸­è¨˜æ†¶é«”çš„é…ç½®ç‹€æ…‹ï¼Œè‹¥ç™¼ç¾æ­¤å°è±¡å·²ç¶“ä¸æœƒè¢«ä½¿ç”¨åˆ°äº†ï¼Œå°±æœƒå›æ”¶è©²å°è±¡æ‰€ä½”ç”¨çš„è¨˜æ†¶é«”è³‡æºã€‚


![å–è‡³ [é€™é‚Š](https://developpaper.com/use-the-android-studio-profiler-tool-to-parse-the-applications-memory-and-cpu-usage-data/){:target="_blank"}](/assets/7d80684dc260/1*_n8GN2lnjLdHYoVHx-BWnA.png)

å–è‡³ [é€™é‚Š](https://developpaper.com/use-the-android-studio-profiler-tool-to-parse-the-applications-memory-and-cpu-usage-data/){:target="_blank"}

JVM æœƒä½¿ç”¨ã€Œ **å¯é”æ€§åˆ†æç®—æ³•** ã€ä¾†åˆ¤æ–·æ˜¯å¦éœ€è¦å›æ”¶è©²ç‰©ä»¶ï¼Œä¹Ÿå°±æ˜¯èªªï¼ŒGC Root æœƒå¾éœæ…‹ç‰©ä»¶æˆ–æ˜¯åŸ·è¡Œä¸­çš„åŸ·è¡Œç·’ç‚ºèµ·é»ï¼Œå¾é€™äº›èµ·å§‹é»å‘ä¸‹æœå°‹ï¼ŒæŸ¥çœ‹é€™å€‹å°è±¡åƒç…§åˆ°å“ªè£¡ï¼Œçœ‹çœ‹é€™å€‹å°è±¡æ˜¯ä¸æ˜¯æœ‰åœ¨ä½¿ç”¨ï¼Œè‹¥ç™¼ç¾éƒ½æ²’åœ¨ä½¿ç”¨ï¼Œå°±æœƒå›æ”¶å®ƒã€‚

è€Œ Memory Leak å°±æ˜¯æŸå€‹ç‰©ä»¶æŒæœ‰æŸå€‹ç‰©ä»¶ä¸æ”¾ï¼Œå°è‡´ GC ä¸€ç›´ä»¥ç‚ºæœ‰åœ¨ä½¿ç”¨ä¸­ï¼Œæ‰€ä»¥æ°¸é ä¹Ÿä¸æœƒå›æ”¶è©²ç‰©ä»¶ã€‚
### Android é–‹ç™¼ä¸­å¸¸è¦‹çš„æ¡ˆä¾‹

åœ¨ Android ä¸­æœ‰å¹¾å€‹å¾ˆå¸¸è¦‹çš„ memory leak ä¾‹å­ï¼Œåƒæ˜¯ï¼š
- register äº†ä¸€å€‹ listenerï¼Œä½†æ²’æœ‰åœ¨ destroy æ™‚ unregister
- å°‡ activity /fragment çš„ context å‚³å…¥æŸç‰©ä»¶ä¸­ï¼Œä½†æ˜¯ activity /fragment éŠ·æ¯€æ™‚æ²’æœ‰è§£é™¤ä»–å€‘ä¹‹é–“çš„é—œä¿‚
- inner classï¼Œåœ¨ activity / fragment ä¸­ä½¿ç”¨ inner class åŸ·è¡Œè€—æ™‚æ“ä½œï¼Œä½†åœ¨ activity / fragment destroy æ™‚ï¼Œinner class é‚„æ²’çµæŸ
- Singleton æŒæœ‰ activity / fragment contextï¼Œç”±æ–¼ Singleton æ˜¯ staticï¼Œç”Ÿå‘½é€±æœŸæ¯” activity / fragment context é‚„é•·ï¼Œå› è€Œè®“ context ç„¡æ³•é‡‹æ”¾

### å¦‚ä½•è§£æ±ºæŠ“å‡º memory leak

ç›®å‰å¤§è‡´ä¸Šæœ‰å…©å€‹å·¥å…·å¯ä»¥å¹«åŠ©æˆ‘å€‘ï¼š
- [Android Studio Profiler](https://developer.android.com/studio/profile/memory-profiler){:target="_blank"}
- [LeakCanary](https://square.github.io/leakcanary/){:target="_blank"}


åœ¨æˆ‘å‰›é–‹å§‹æ¥è§¸ Android æ™‚ï¼Œç•¶æ™‚æœ€ç«ç´…çš„å°±æ˜¯ LeakCanaryï¼Œä½†éš¨è‘—æ™‚ä»£çš„æ¼”é€²ï¼ŒAndroid Studio çš„é€²æ­¥ï¼Œç¾åœ¨ç”¨ IDE å…§å»ºçš„ Profiler å°±å·²ç¶“å¾ˆå¥½ç”¨æ‹‰ï¼æ‰€ä»¥ä¸‹é¢æˆ‘å€‘å°±è‘—é‡åœ¨ Profiler ä¸Šé¢ä»‹ç´¹ã€‚
#### Profiler

ä½ç½®ï¼š

IDE çš„ä¸Šæ–¹è·Ÿä¸‹æ–¹éƒ½æœ‰å…¥å£å¯ä»¥çœ‹åˆ°


![åœ¨ IDE å³ä¸Šæ–¹æœ‰å€‹å°åœ–ç¤ºå¯ä»¥é€²å…¥](/assets/7d80684dc260/1*5knMdrnVu62LTjSqGfNWyA.png)

åœ¨ IDE å³ä¸Šæ–¹æœ‰å€‹å°åœ–ç¤ºå¯ä»¥é€²å…¥


![IDE ä¸‹æ–¹](/assets/7d80684dc260/1*QH-Ls2GlBhkcwROnv09Ukw.png)

IDE ä¸‹æ–¹

é»é–‹ä¾†å¾Œä½ æœƒçœ‹åˆ° Profiler é–‹å§‹è¨˜éŒ„ç›®å‰çš„ CPUã€MEMORYã€NETWORKã€ENERGY çš„å€‹åˆ¥ä½¿ç”¨ç‹€æ³


![](/assets/7d80684dc260/1*b2F6dtSKQks91ky1pSRBLA.png)


è€Œæˆ‘å€‘è¦æŠ“ memory leakï¼Œæ‰€ä»¥å°±å¾€ memory é‚£å€‹å€å¡Šä»»æ„åœ°æ–¹é»ä¸€ä¸‹


![](/assets/7d80684dc260/1*vNifOqUnunuumv3o2zXT0Q.png)


é»æ“Šä¹‹å¾Œæœƒæ”¾å¤§ memory å€å¡Šçš„ä½¿ç”¨æƒ…æ³ï¼Œå…¶ä¸­å·¦é‚Šæœ‰å€‹ã€ŒCapture heap dumpã€ï¼Œæˆ‘å€‘å°±æ˜¯éœ€è¦é å®ƒä¾†å¹«åŠ©æˆ‘å€‘ dump å‡º memory ä½¿ç”¨ç‹€æ³ï¼ŒæŠ“å‡ºæ´©æ¼çš„åœ°æ–¹


![](/assets/7d80684dc260/1*inwkZ8G5GqzLPh2HPs7eUg.png)


å…ˆè©¦è‘—é»æ“Šçœ‹çœ‹ã€ŒCapture heap dumpã€ç„¶å¾Œé»é¸ã€ŒRecordã€ï¼Œç¨ç­‰ä¸€ä¸‹å¾Œæœƒå‡ºç¾ memory åˆ†æå¾Œçš„çµæœï¼Œå…¶ä¸­ç‰¹åˆ¥è¦è·Ÿå¤§å®¶ä»‹ç´¹çš„æ˜¯ä¸‹åœ–ç´…æ¡†ä¸­çš„å¹¾å€‹åè©æ‰€ä»£è¡¨çš„æ„æ€


![](/assets/7d80684dc260/1*XGtOVCqOA992haXY-dYGUg.png)


ç‚ºäº†æ€•æˆ‘è§£é‡‹æœ‰èª¤ï¼Œå…ˆè²¼ä¸Š [å®˜æ–¹èªªæ˜](https://developer.android.com/studio/profile/memory-profiler){:target="_blank"} å¦‚ä¸‹ï¼š
- **Allocations** : Number of allocations in the heap\.
- **Native Size** : Total amount of native memory used by this object type \(in bytes\) \. This column is visible only for Android 7\.0 and higher\.
- You will see memory here for some objects allocated in Java because Android uses native memory for some framework classes, such as `Bitmap` \.
- **Shallow Size** : Total amount of Java memory used by this object type \(in bytes\) \.
- **Retained Size** : Total size of memory being retained due to all instances of this class \(in bytes\) \.


æ¥è‘—ä¾†çœ‹ä¸€ä¸‹é€™äº›åè©æ‰€ä»£è¡¨çš„æ„æ€ï¼Œç”¨åœ–ç‰‡ä¾†çœ‹æœƒæ›´å®¹æ˜“ç†è§£ã€‚

ä»¥ä¸‹åœ–ç‰‡ Heap åœ–ä¾†è‡³é€™å€‹ [ç¶²ç«™](https://developpaper.com/use-the-android-studio-profiler-tool-to-parse-the-applications-memory-and-cpu-usage-data/){:target="_blank"}

Heap æœ‰åˆ†ç‚º Native å’Œ Javaï¼Œæ¯å€‹ APP éƒ½æœ‰ä¸€å€‹è¢«åˆ†é…å¯ä½¿ç”¨çš„è¨˜æ†¶é«”å¤§å°ï¼Œç•¶ APP ä½¿ç”¨è¶…éé€™å€‹è¨˜æ†¶é«”å¤§å°çš„æ™‚å€™ï¼Œå³æœƒç™¼ç”Ÿæ‰€è¬‚çš„ OOMã€‚

ä¸‹åœ–è¡¨ç¤ºæŸå€‹æ®µ Heap Dump è¨˜éŒ„çš„ APP è¨˜æ†¶é«”ç‹€æ…‹ã€‚

æ³¨æ„ç´…è‰²çš„ç¯€é»ï¼Œåœ¨é€™å€‹åœ–ä¸­ï¼Œç´…è‰²ç¯€é»å¼•ç”¨äº† Native Heapã€‚


![](/assets/7d80684dc260/1*DLLAyvkw1NEw-eAVvoOPlw.png)


é€™å¼µåœ–çš„ç‹€æ³ä¸å¤ªå¸¸è¦‹ï¼Œä½†åœ¨ Android 8\.0 é–‹å§‹ï¼Œå¯èƒ½æœƒæŠŠ Bitmap å­˜æ”¾åœ¨ Native å…§ï¼Œæ¸›å°‘ JVM çš„å­˜æ”¾å£“åŠ›ã€‚

æ‰€ä»¥å¯ä»¥çœ‹åˆ°åœ–ä¸­çš„ç´…è‰²ç¯€é»å­˜æ”¾åœ¨ Java Heap ä¸”åŒæ™‚æŒ‡å‘ Native Heapã€‚

ã€ŒNative Sizeã€ï¼šç‰©ä»¶ä½¿ç”¨ native memory çš„å¤§å°ï¼Œè—è‰²ç¯€é»

ã€ŒShallow Sizeã€ï¼šç‰©ä»¶æœ¬èº«æ¶ˆè€— memory çš„å¤§å°ï¼Œç´…è‰²ç¯€é»


![](/assets/7d80684dc260/1*N2wQKDGWhMSDHoh2JoY6Ag.png)


ã€ŒRetained Sizeã€ å‰‡æ˜¯ä¸‹åœ–æ©˜è‰²ç¯€é»ï¼Œä»£è¡¨çš„æ˜¯ç´…è‰²ç¯€é»æ‰€åƒç…§åˆ°å¾Œé¢çš„ç‹€æ…‹ï¼ŒRetained Size å¯èƒ½æœƒå¾ˆå¤§ï¼Œå› ç‚ºå¾Œé¢çš„ç¯€é»æ˜¯å¯ä»¥é‡è¤‡è¨ªå•çš„ã€‚

æˆ‘å€‘å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä»Šå¤©æŠŠç´…è‰²ç¯€é»åˆªé™¤å¾Œï¼Œé€™äº›æ©˜è‰²ç¯€é»å°‡æ²’æœ‰è¢«åƒç…§åˆ°ï¼Œæ‰€ä»¥å°‡æœƒè¢« GC å›æ”¶ã€‚


![](/assets/7d80684dc260/1*zmxZjBZpUTDtIneUb8K5sw.png)


æ¥è‘—æˆ‘å€‘å›åˆ° Profilerï¼Œé»æ“Šéš¨ä¾¿ä¸€å€‹ class nameï¼Œæœƒè·‘å‡ºä¸€å€‹ instance listï¼Œä¸¦ä¸”å³æ–¹å¤šäº†ä¸€å€‹ã€ŒDepthã€


![](/assets/7d80684dc260/1*gT92ecqwpXV1zmmilEsI4w.png)


é€™å€‹ ã€ŒDepthã€æ‰€ä»£è¡¨çš„æ„æ€æ˜¯å¾ã€ŒGC root åˆ°ç‰©ä»¶ instance è¦ç¶“éçš„æ·±åº¦ã€


![](/assets/7d80684dc260/1*kqED3ONhzo-L2-mMqDLlKA.png)


ä»¥ä¸Šåœ–ä¾†çœ‹çš„è©±ï¼Œè—è‰²ç¯€é»çš„ Depth ç‚º 2ï¼Œç´…è‰²ç¯€é» Depth ç‚º 7ï¼Œè‹¥æˆ‘å€‘ä»Šå¤©æƒ³è¦å›æ”¶é€™å…©å€‹ç¯€é»

ä»¥ç´…è‰²ä¾†èªªï¼Œåªè¦å·¦æ–¹å…¶ä¸­ä¸€å€‹ç¯€é»è¢«ç ´å£ï¼Œç´…è‰²ç¯€é»å°±ç„¡æ³•è¢« GC Root è¨ªå•ï¼Œæ‰€ä»¥æœƒè¢«å›æ”¶

ä»¥è—è‰²ä¾†èªªï¼Œç”±æ–¼è¢«å…©å€‹ç¯€é»æ‰€æŒ‡å‘ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦åŒæ™‚ç ´å£è—è‰²ç¯€é»çš„å·¦å³å…©å€‹ç¯€é»æ‰èƒ½ä½¿è—è‰²ç¯€é»è¢«å›æ”¶
#### **é‚£ä»Šå¤©å¦‚æœ ã€ŒDepthã€ç‚º 1 å‘¢ï¼Ÿ**

ä»£è¡¨é€™å€‹ç¯€é»ç›´æ¥è¢« GC Root å¼•ç”¨ï¼Œæ‰€ä»¥æ°¸é ä¹Ÿä¸æœƒè¢«å›æ”¶ï¼Œä»¥ Android ä¾†èªªï¼Œå¦‚æœåœ¨ activity è¨»å†Šäº†ä¸€å€‹äº‹ä»¶ï¼ˆå¦‚:LocationListenerï¼‰ï¼Œä½†æ²’æœ‰åœ¨ activity è¢«éŠ·æ¯€æ™‚åè¨»å†Šï¼Œå°±æœƒé€ æˆ memory leakã€‚
#### å¦‚ä½•æ‰¾å‡º Memory Leak ?

æˆ‘å€‘å¯ä»¥é€šéä¸€äº›æ–¹æ³•ä¾†æ¸¬è©¦çœ‹çœ‹æ˜¯ä¸æœ‰ memory leak çš„å•é¡Œï¼š
- é€²å…¥ä¸€å€‹é é¢ç„¶å¾Œå‡ºä¾†ï¼Œå†é€²å»ä¸€å€‹é é¢ï¼Œç„¶å¾Œå‡ºä¾†ï¼Œåè¦†åœ°é€²å‡ºç›¸åŒæˆ–ä¸åŒçš„é é¢ï¼Œè§€å¯Ÿè¨˜æ†¶é«”çš„è®ŠåŒ–ï¼Œæ˜¯æŒçºŒä¸Šå‡?é‚„æ˜¯æœƒåœ¨é›¢é–‹ç•«é¢æ™‚é™å›å»
- æ—‹è½‰è¢å¹•ç•«é¢å¤šæ¬¡ï¼Œä½¿ activity lifecycle é‡æ–°å»ºç«‹

#### ç¾åœ¨æˆ‘å€‘ä¾†æ¸¬è©¦ä¸€å€‹å¯¦éš›çš„ä¾‹å­
1. ä¸€é–‹å§‹çš„æ™‚å€™ call Stack å’Œ Heap éƒ½æ˜¯ç©ºçš„



![](/assets/7d80684dc260/1*pLBhcJ4QOKO0fmVAKE6rTg.png)


2\. æ¥ä¸‹ä¾†æˆ‘å€‘å‰µä¸€å€‹ activityï¼Œåœ¨è£¡é¢æœƒéœ€è¦åŸ·è¡Œä¸€æ®µè€—æ™‚çš„æ“ä½œ \(DownloadTask\)

é€™å€‹éšæ®µæ˜¯ä½¿ç”¨è€…æ‰“é–‹ APP å¾Œç™¼ç”Ÿçš„è¡Œç‚º
```kotlin
class MainActivity : AppCompatActivity() {

  private lateinit var binding: ActivityMainBinding
  var downloadTask: DownloadTask? = null

  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    binding = ActivityMainBinding.inflate(layoutInflater)
    setContentView(binding.root)

    downloadTask = DownloadTask()
    downloadTask?.start()
  }

  class DownloadTask : Thread() {

    override fun run() {
      sleep(60 * 1000)//60 second
    }

  }
}
```


![MainActivity invoke DownloadTask](/assets/7d80684dc260/1*S2MtBptNjKCNc7jHOZW06g.png)

MainActivity invoke DownloadTask

æ­¤æ™‚ Stack ä¸­ MainActivity è¢« new å‡ºä¾†æ”¾åœ¨ Heapï¼ŒåŒæ™‚ MainActivity ä¹Ÿ new äº† DownloadTask ä¸¦ä¸” call run\( \)

2\. æ¥è‘—ç‚ºäº†è¦åœ¨ä¸‹è¼‰å®Œæˆæ™‚é€šçŸ¥ä½¿ç”¨è€…ï¼Œæˆ‘æŠŠ MainActivity context å‚³å…¥ DownloadTask
```kotlin
class MainActivity : AppCompatActivity() {

  private lateinit var binding: ActivityMainBinding
  var downloadTask: DownloadTask? = null

  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    binding = ActivityMainBinding.inflate(layoutInflater)
    setContentView(binding.root)

    downloadTask = DownloadTask(this)
    downloadTask?.start()
  }

  class DownloadTask(val holdActivity: Activity) : Thread() {

    var toast: Toast? = null
    override fun run() {
      sleep(30 * 1000)//30 second
      holdActivity.runOnUiThread {
        toast = Toast.makeText(holdActivity, "download finish", Toast.LENGTH_SHORT)
        toast?.show()
      }
    }

  }
}
```


![DownloadTask æŒæœ‰ MainActivity context](/assets/7d80684dc260/1*kxDW180U5bVL7b3wUurUtw.png)

DownloadTask æŒæœ‰ MainActivity context

3\. ä½†æ˜¯ä½¿ç”¨è€…åœ¨ä¸€é€²å…¥ APP\(MainActivity\)æ™‚å°±é¦¬ä¸Šé€€å‡ºäº† APPï¼Œæ­¤æ™‚ DownloadTask ä¾ç„¶é‚„åœ¨åŸ·è¡Œï¼Œmemory ç‹€æ…‹è®Šæˆï¼š


![ç™¼ç”Ÿ leak äº†](/assets/7d80684dc260/1*EF9CFlodqME0jmZOURblXw.png)

ç™¼ç”Ÿ leak äº†

æ­¤æ™‚æˆ‘å€‘ç”¨ Profiler ä¾†æª¢æŸ¥å“ªé‚Šç™¼ç”Ÿ leakï¼Œæˆ‘å€‘ä¸€æ¨£å…ˆæŠŠ memory dump å‡ºä¾†å¾Œï¼Œæœƒå¾ˆæ˜é¡¯çš„ç™¼ç¾ Profiler å¹«æˆ‘å€‘æ¨™æ³¨å‡ºä¾†å“ªé‚Š Leak äº†


![](/assets/7d80684dc260/1*_J2zvfpHg0tBfhFiYckcmQ.png)


æ¥è‘—é»æ“Š Leaksï¼Œæˆ‘å€‘ç™¼ç¾ MainActivity æœ‰ leak çš„ç¾è±¡


![](/assets/7d80684dc260/1*k2H9WqOwF5qByUGCSLY9cg.png)


é»æ“Š Class ä¸­çš„ MainActivityï¼Œå†é»é¸ MainActivity Instanceï¼Œæ¥è‘—çœ‹åˆ°å³æ–¹çš„ Referencesï¼Œé€™é‚Šå¯ä»¥å¹«åŠ©æˆ‘å€‘åˆ¤æ–·æ˜¯å“ªå€‹ç‰©ä»¶è¢«å¡ä½äº†


![](/assets/7d80684dc260/1*oxBIscqwS8c7qlEsQ0k4NA.png)


å¾ References ä¸­æˆ‘å€‘å¯ä»¥å¾ˆå¿«çœ‹åˆ° holdActivity é‚„æ®˜ç•™åœ¨ DownloadTask ä¸­æ²’æœ‰è¢«æ¸…é™¤


![](/assets/7d80684dc260/1*wkPuBTeJahiQ7PtlDVswKw.png)


4\. ç™¼ç¾ memory leak åŸå› åœ¨æ–¼ DownloadTask æŒæœ‰ MainActivity contextï¼Œä¸”åŸ·è¡Œæ™‚é–“æ¯” MainActivity é‚„ä¹…ï¼Œæ‰€ä»¥æˆ‘å€‘åœ¨ onDestroy æ™‚æŠŠ DownloadTask çš„ context æ¸…é™¤ï¼Œé¿å… leak
```kotlin
class MainActivity : AppCompatActivity() {

  private lateinit var binding: ActivityMainBinding
  var downloadTask: DownloadTask? = null

  override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    binding = ActivityMainBinding.inflate(layoutInflater)
    setContentView(binding.root)

    downloadTask = DownloadTask(this)
    downloadTask?.start()
  }

  class DownloadTask(var holdActivity: Activity?) : Thread() {

    var toast: Toast? = null
    override fun run() {
      sleep(30 * 1000)//30 second
      holdActivity?.runOnUiThread {
        toast = Toast.makeText(holdActivity, "download finish", Toast.LENGTH_SHORT)
        toast?.show()
      }
    }
  }

  override fun onDestroy() {
    downloadTask?.holdActivity = null //avoid memory leak
    super.onDestroy()
  }
}
```

æˆ‘å€‘é æœŸé›¢é–‹ APP æ™‚ï¼ŒHeap ä¸­æ‡‰è©²éƒ½è¦æ˜¯ç©ºçš„ï¼Œå›åˆ°åˆå§‹ç‹€æ…‹ï¼Œæ‰€ä»¥æˆ‘å€‘ç”¨ Profiler æª¢æŸ¥çœ‹çœ‹
### ä½†æ˜¯â€¦
#### æ€éº¼é‚„æ˜¯ Leak äº†ï¼Ÿ


![Photo by [arash payam](https://unsplash.com/@arash_payam?utm_source=medium&utm_medium=referral){:target="_blank"} on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral){:target="_blank"}](/assets/7d80684dc260/0*ZG02635Wa0gKYJi3)

Photo by [arash payam](https://unsplash.com/@arash_payam?utm_source=medium&utm_medium=referral){:target="_blank"} on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral){:target="_blank"}


![](/assets/7d80684dc260/1*acJDHtm-snmdvOUHJs1VYw.png)


åœ¨ onDestroy åšå®Œ holdActiviy = null ä¹‹å¾Œï¼Œä½ å¯èƒ½æœƒç™¼ç¾é‚„æ˜¯ç™¼ç”Ÿ Leakï¼Œä¸éåˆ¥æ“”å¿ƒï¼Œé€™æ˜¯å› ç‚º GC çš„æ©Ÿåˆ¶å°è‡´çš„ï¼ŒGC ä¸æœƒåœ¨ç‰©ä»¶æ²’æœ‰è¢«ä½¿ç”¨æ™‚å°±é¦¬ä¸Šå›æ”¶ç‰©ä»¶ï¼Œè€Œæ˜¯æœƒéä¸€æ®µæ™‚é–“æ‰å›æ”¶ï¼Œä»–å°±åƒåƒåœ¾è»Šä¸€æ¨£ï¼Œä¸€æ®µæ™‚é–“æˆ–æ˜¯æœ‰éœ€è¦æ”¶åƒåœ¾äº†æ‰ä¾†ã€‚

é‚„å¥½ Profiler æœ‰å€‹å¾ˆæ£’çš„åŠŸèƒ½å¯ä»¥è§£æ±ºé€™ä»¶äº‹ï¼Œæˆ‘å€‘å¯ä»¥åœ¨ memory dump çš„é‚£å€‹ä»‹é¢çš„ä¸Šæ–¹æ‰¾åˆ°ä¸€å€‹åƒåœ¾æ¡¶ï¼Œä»–çš„ä½œç”¨å°±æ˜¯å¼·åˆ¶å‘¼å«åƒåœ¾è»Š\(GC\)ä¾†æ”¶åƒåœ¾ï¼


![é»æ“Šåƒåœ¾æ¡¶](/assets/7d80684dc260/1*cClSgNaDWjt5uL8TSZ53dg.png)

é»æ“Šåƒåœ¾æ¡¶

é»æ“Šåƒåœ¾æ¡¶å¾Œä¹Ÿä¸è¦é¦¬ä¸Š dump å“¦ï¼Œé»æ“Šä¹‹å¾Œï¼Œä½ æœƒçœ‹åˆ° memory åœ–è¡¨çš„ä¸‹æ–¹æœƒå‡ºç¾ä¸€å€‹åƒåœ¾æ¡¶ï¼Œç­‰ä»–å‡ºç¾å¾Œåœ¨ Capture heap dump


![æŸ¥çœ‹åƒåœ¾æ¡¶](/assets/7d80684dc260/1*Lq1KVJXqmyM-2AAslb0acQ.png)

æŸ¥çœ‹åƒåœ¾æ¡¶

çœ‹åˆ°åƒåœ¾æ¡¶ä¹‹å¾Œæˆ‘å€‘å°±å¯ä»¥å†æ¬¡ dump çœ‹çœ‹æ˜¯ä¸æ˜¯çœŸçš„è§£æ±ºäº† memory leakäº†


![leak æ¶ˆå¤±äº† ğŸ‘](/assets/7d80684dc260/1*KuvZgcLVmghor3sIGkZHCw.png)

leak æ¶ˆå¤±äº† ğŸ‘
### çµèª

Memory Leak çš„å•é¡Œå¯å¤§å¯å°ï¼Œæ”¸é—œä½¿ç”¨è€…çš„è£ç½®æ•ˆèƒ½ã€ä½¿ç”¨ app çš„ä½¿ç”¨æœŸé–“é•·çŸ­ï¼Œä¸€é»é»çš„ memory leak å°æ•ˆèƒ½å¥½çš„æ‰‹æ©Ÿå¯èƒ½æ²’æ„Ÿè¦ºï¼Œä½†æ˜¯ä½¿ç”¨èˆŠä¸€é»çš„æ‰‹æ©Ÿå¯èƒ½å°±æ™‚å¸¸æœƒé‡åˆ°é–ƒé€€çš„ç‹€æ³ã€‚ä¹Ÿç®—æ˜¯ä¸€å€‹ç„¡è²çš„æ®ºæ‰‹ï¼Œé»˜é»˜åœ°å°±çªç„¶ä¾†çš„é–ƒé€€ã€‚

å®Œæ•´ç¯„ä¾‹ä¹Ÿå·²ç¶“æ”¾ä¸Š GitHubï½


[![](https://opengraph.githubassets.com/91da17cd11970140791bef099a13aef52235e35c046fbe041c36d5b4c78e0361/pinkoi-inc/Android-Memory-Leak-Demo)](https://github.com/pinkoi-inc/Android-Memory-Leak-Demo){:target="_blank"}


åƒè€ƒæ–‡ç« ï¼š
- [https://proandroiddev\.com/everything\-you\-need\-to\-know\-about\-memory\-leaks\-in\-android\-d7a59faaf46a](https://proandroiddev.com/everything-you-need-to-know-about-memory-leaks-in-android-d7a59faaf46a){:target="_blank"}
- [https://coffeewithcode\.medium\.com/android\-memory\-leaks\-by\-programmers\-mistake\-65d46fcfa718](https://coffeewithcode.medium.com/android-memory-leaks-by-programmers-mistake-65d46fcfa718){:target="_blank"}
- [https://www\.jyt0532\.com/2020/03/12/garbage\-collector/](https://www.jyt0532.com/2020/03/12/garbage-collector/){:target="_blank"}


è‹¥å°æ–‡ç« æœ‰ä»»ä½•æƒ³æ³•æˆ–æ˜¯æœ‰éœ€è¦èª¿æ•´çš„åœ°æ–¹æ­¡è¿å¤§å®¶ç•™è¨€ï¼Œè‹¥è¦ºå¾—ä¸éŒ¯çš„è©±ä¹Ÿæ­¡è¿çµ¦æˆ‘ä¸€äº›æŒè² ğŸ‘



_[Post](https://medium.com/pinkoi-engineering/android-%E6%8A%93%E5%88%B0%E4%BA%86-memory-leak-7d80684dc260){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
